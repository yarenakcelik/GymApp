@model GymApp.Models.ViewModels.AICenterViewModel
@{
    ViewData["Title"] = "AI Center";
}

<h2 class="mt-4 mb-2">AI Center</h2>
<p class="text-muted">
    Hedefinize göre antrenman + beslenme önerisi alabilir, ayrıca sistemdeki hizmetlerden size uygun olanları görebilirsiniz.
</p>

@if (!string.IsNullOrWhiteSpace(Model.Error))
{
    <div class="alert alert-danger">
        <strong>AI servisine bağlanırken hata oluştu:</strong> @Model.Error
    </div>
}

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <form asp-action="Index" method="post">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label class="form-label">Hedef</label>
                        <select asp-for="Request.Goal" class="form-select">
                            <option value="Kilo Verme">Kilo Verme</option>
                            <option value="Kas Geliştirme">Kas Geliştirme</option>
                            <option value="Fit / Kondisyon">Fit / Kondisyon</option>
                        </select>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">Yaş</label>
                            <input asp-for="Request.Age" class="form-control" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Boy (cm)</label>
                            <input asp-for="Request.HeightCm" class="form-control" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kilo (kg)</label>
                            <input asp-for="Request.WeightKg" class="form-control" />
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Seviye</label>
                            <select asp-for="Request.Level" class="form-select">
                                <option value="Başlangıç">Başlangıç</option>
                                <option value="Orta">Orta</option>
                                <option value="İleri">İleri</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Haftada kaç gün?</label>
                            <input asp-for="Request.DaysPerWeek" class="form-control" />
                        </div>
                    </div>

                    <div class="mt-2 mb-3">
                        <label class="form-label">Ekipman Tercihi</label>
                        <select asp-for="Request.Equipment" class="form-select">
                            <option value="Ekipmansız">Ekipmansız</option>
                            <option value="Ev / Dumbbell">Ev / Dumbbell</option>
                            <option value="Salon / Makineler">Salon / Makineler</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        Öneri Al
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="alert alert-info h-100">
            <div class="mb-3">
                <label class="form-label"><b>Yemek Fotoğrafı Yükle</b></label>
                <input id="mealPhoto" type="file" class="form-control" accept="image/*" />
                <small class="text-muted">Örn: tabakta yemek fotoğrafı. Net ve yakın çekim daha iyi.</small>
            </div>

            <div class="d-flex gap-2 mb-3">
                <button id="btnAnalyze" class="btn btn-primary">
                    Fotoğrafı Analiz Et
                </button>

                <div id="analyzeLoading" class="text-muted d-none">Analiz ediliyor...</div>
            </div>

            <div id="mealResult" class="p-3 bg-white rounded d-none">
                <!-- burada sonuç basılacak -->
            </div>

            <div id="mealError" class="alert alert-danger d-none mt-2"></div>

            <div class="mt-3 text-center">
                <span>AI önerisi almak için soldaki formu doldurup <b>Öneri Al</b>'a bas.</span>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            function getAntiForgeryToken() {
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                return token ? token.value : "";
            }

            function showError(msg) {
                const err = document.getElementById("mealError");
                err.textContent = msg;
                err.classList.remove("d-none");
            }

            function clearError() {
                const err = document.getElementById("mealError");
                err.textContent = "";
                err.classList.add("d-none");
            }

            document.getElementById("btnAnalyze").addEventListener("click", async () => {
                clearError();

                const fileInput = document.getElementById("mealPhoto");
                const file = fileInput.files[0];
                if (!file) {
                    showError("Lütfen bir fotoğraf yükleyin.");
                    return;
                }

                const loading = document.getElementById("analyzeLoading");
                loading.classList.remove("d-none");

                const fd = new FormData();
                fd.append("photo", file);

                // Anti-forgery
                fd.append("__RequestVerificationToken", getAntiForgeryToken());

                try {
                    const res = await fetch("/AICenter/AnalyzeMeal", {
                        method: "POST",
                        body: fd
                    });

                    const json = await res.json();

                    loading.classList.add("d-none");

                    if (!json.ok) {
                        showError(json.message || "Analiz başarısız.");
                        return;
                    }

                    const resultDiv = document.getElementById("mealResult");
                    resultDiv.classList.remove("d-none");

                    if (!json.hasPlate) {
                        resultDiv.innerHTML = `<b>${json.message}</b>`;
                        return;
                    }

                    const d = json.data;

                    resultDiv.innerHTML = `
                        <h5 class="mb-2">Tahmini Tabak Analizi</h5>
                        <div><b>Yemek:</b> ${d.mealName}</div>
                        <div><b>Porsiyon:</b> ~${d.estimatedGrams} g</div>
                        <hr/>
                        <div><b>Kalori:</b> ${d.caloriesKcal} kcal</div>
                        <div><b>Protein:</b> ${d.proteinG} g</div>
                        <div><b>Karbonhidrat:</b> ${d.carbsG} g</div>
                        <div><b>Yağ:</b> ${d.fatG} g</div>
                        <hr/>
                        <small class="text-muted">${d.notes || "Not: Bu değerler fotoğrafa göre yaklaşık tahmindir."}</small>
                    `;
                } catch (e) {
                    loading.classList.add("d-none");
                    showError("Bir hata oluştu. " + e);
                }
            });
        </script>
    }

</div>
