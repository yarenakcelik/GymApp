@model IEnumerable<GymApp.Models.Appointment>

@{
    ViewData["Title"] = "Randevularım";
}

<h2 class="mt-4 mb-3">Randevularım</h2>

@* Anti-forgery token üretmek için gizli form  *@
<form id="tokenForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<form id="filterForm" class="mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-auto">
            <label class="form-label">Duruma göre filtrele</label>
            <select id="statusSelect" class="form-select">
                <option value="All">Hepsi</option>
                <option value="Pending">Onay Bekliyor</option>
                <option value="Approved">Onaylandı</option>
                <option value="Rejected">Reddedildi</option>
                <option value="Cancelled">İptal Edildi</option>
            </select>
        </div>
        <div class="col-auto">
            <button id="btnFilter" type="submit" class="btn btn-primary">Filtrele</button>
        </div>
    </div>
</form>

<div id="emptyAlert" class="alert alert-info d-none">
    Henüz bir randevunuz bulunmuyor.
</div>

<table id="apptTable" class="table table-striped table-hover align-middle d-none">
    <thead class="table-light">
        <tr>
            <th>Hizmet</th>
            <th>Spor Salonu</th>
            <th>Antrenör</th>
            <th>Başlangıç</th>
            <th>Süre (dk)</th>
            <th>Ücret</th>
            <th>Durum</th>
            <th>İşlemler</th>
        </tr>
    </thead>
    <tbody id="apptBody">
        <tr><td colspan="8">Yükleniyor...</td></tr>
    </tbody>
</table>

@section Scripts {
    <script>
        function getAntiForgeryToken() {
            const el = document.querySelector('#tokenForm input[name="__RequestVerificationToken"]');
            return el ? el.value : "";
        }

        function statusToText(status) {
            switch (status) {
                case "Pending": return "Onay Bekliyor";
                case "Approved": return "Onaylandı";
                case "Rejected": return "Reddedildi";
                case "Cancelled": return "İptal Edildi";
                default: return status || "-";
            }
        }

        function canEditOrCancel(item) {
            // item.startTime ISO gelecek, Date parse edeceğim
            const start = new Date(item.startTime);
            const now = new Date();

            return start > now && item.status !== "Cancelled" && item.status !== "Rejected";
        }

        async function loadAppointments() {
            const status = document.getElementById("statusSelect").value;

            let url = "/api/appointments/my";
            if (status && status !== "All") {
                url += "?status=" + encodeURIComponent(status);
            }

            const res = await fetch(url);
            const data = await res.json();

            const tbody = document.getElementById("apptBody");
            const emptyAlert = document.getElementById("emptyAlert");
            const table = document.getElementById("apptTable");

            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                table.classList.add("d-none");
                emptyAlert.classList.remove("d-none");
                return;
            }

            emptyAlert.classList.add("d-none");
            table.classList.remove("d-none");

            data.forEach(item => {
                const statusText = statusToText(item.status);

                let actionsHtml = `<span class="text-muted">-</span>`;

                if (canEditOrCancel(item)) {
                    
                    const editUrl = `/Appointments/Edit/${item.id}`;

                  
                    const token = getAntiForgeryToken();

                    actionsHtml = `
                        <a href="${editUrl}" class="btn btn-sm btn-outline-primary me-1">Düzenle</a>

                        <form action="/Appointments/Cancel/${item.id}" method="post" class="d-inline"
                              onsubmit="return confirm('Bu randevuyu iptal etmek istediğinize emin misiniz?');">
                            <input name="__RequestVerificationToken" type="hidden" value="${token}" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">İptal Et</button>
                        </form>
                    `;
                }


                const startText = item.startTimeText
                    ? item.startTimeText
                    : new Date(item.startTime).toLocaleString();

                tbody.innerHTML += `
                    <tr>
                        <td>${item.serviceName ?? "-"}</td>
                        <td>${item.gymName ?? "-"}</td>
                        <td>${item.trainerName ?? "-"}</td>
                        <td>${startText}</td>
                        <td>${item.durationMinutes ?? 0}</td>
                        <td>${item.priceText ?? "-"}</td>
                        <td>${statusText}</td>
                        <td>${actionsHtml}</td>
                    </tr>
                `;
            });
        }

        document.getElementById("filterForm").addEventListener("submit", function (e) {
            e.preventDefault(); 
            loadAppointments();
        });


        loadAppointments();
    </script>
}
